<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics | Sentiment AI</title>
    <meta name="description"
        content="Emotion analytics: distribution pie chart, frequency bar chart, trends over time, and average confidence per emotion." />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <link rel="stylesheet" href="styles/main.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="app-body">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <div class="brand-icon">
                <span class="material-symbols-outlined">sentiment_very_satisfied</span>
            </div>
            <div class="brand-text">
                <span class="brand-name">Sentiment AI</span>
                <span class="brand-version">v1.0.0</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item" id="nav-home">
                <span class="material-symbols-outlined">home</span>
                <span>Dashboard</span>
            </a>
            <a href="live_detection.html" class="nav-item" id="nav-live">
                <span class="material-symbols-outlined">videocam</span>
                <span>Live Detection</span>
            </a>
            <a href="upload.html" class="nav-item" id="nav-upload">
                <span class="material-symbols-outlined">upload_file</span>
                <span>Upload Image</span>
            </a>
            <a href="logs.html" class="nav-item" id="nav-logs">
                <span class="material-symbols-outlined">receipt_long</span>
                <span>Logs</span>
            </a>
            <a href="analytics.html" class="nav-item active" id="nav-analytics">
                <span class="material-symbols-outlined">bar_chart</span>
                <span>Analytics</span>
            </a>
        </nav>
        <div class="sidebar-bottom">
            <div class="sidebar-user-card">
                <div class="user-avatar-sm" id="sidebarAvatar">U</div>
                <div>
                    <span class="user-name-sm" id="sidebarName">User</span>
                    <span class="user-role-sm" id="sidebarEmail">user@email.com</span>
                </div>
            </div>
            <a href="index.html" class="nav-item logout" onclick="handleLogout()">
                <span class="material-symbols-outlined">logout</span>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main -->
    <main class="main-content">
        <header class="topbar analytics-topbar">
            <h2 class="page-title">
                <span class="material-symbols-outlined"
                    style="font-size:20px;vertical-align:middle;color:var(--primary)">bar_chart</span>
                Analytics
            </h2>
            <div class="topbar-right">
                <div class="time-filter-group">
                    <button class="time-filter-btn active" id="tfBtn7" onclick="setTimeFilter(this,'7')">Last 7
                        Days</button>
                    <button class="time-filter-btn" id="tfBtn30" onclick="setTimeFilter(this,'30')">Last 30
                        Days</button>
                    <button class="time-filter-btn" id="tfBtnAll" onclick="setTimeFilter(this,'all')">All Time</button>
                </div>
                <button class="btn-export" onclick="exportAnalytics()">
                    <span class="material-symbols-outlined">file_download</span>
                    Export
                </button>
                <div class="user-pill">
                    <div class="user-avatar" id="topbarAvatar">U</div>
                    <span id="topbarName">User</span>
                </div>
            </div>
        </header>

        <div class="page-body">

            <!-- Stat Cards -->
            <div class="analytics-stats-grid">
                <div class="analytics-stat-card">
                    <div class="analytics-stat-header">
                        <span class="analytics-stat-label">Total Detections</span>
                        <div class="analytics-stat-icon blue">
                            <span class="material-symbols-outlined">visibility</span>
                        </div>
                    </div>
                    <span class="analytics-stat-value" id="statTotal">â€”</span>
                    <span class="analytics-stat-change positive" id="statTotalSub">From emotion logs</span>
                </div>
                <div class="analytics-stat-card">
                    <div class="analytics-stat-header">
                        <span class="analytics-stat-label">Dominant Emotion</span>
                        <div class="analytics-stat-icon blue">
                            <span class="material-symbols-outlined">sentiment_very_satisfied</span>
                        </div>
                    </div>
                    <span class="analytics-stat-value" id="statDominant">â€”</span>
                    <span class="analytics-stat-sub" id="statDominantSub">Most frequent</span>
                </div>
                <div class="analytics-stat-card">
                    <div class="analytics-stat-header">
                        <span class="analytics-stat-label">Avg. Confidence</span>
                        <div class="analytics-stat-icon blue">
                            <span class="material-symbols-outlined">verified</span>
                        </div>
                    </div>
                    <span class="analytics-stat-value" id="statAvgConf">â€”</span>
                    <span class="analytics-stat-change positive" id="statConfSub">CNN classifier accuracy</span>
                </div>
                <div class="analytics-stat-card">
                    <div class="analytics-stat-header">
                        <span class="analytics-stat-label">Detection Sources</span>
                        <div class="analytics-stat-icon blue">
                            <span class="material-symbols-outlined">source</span>
                        </div>
                    </div>
                    <span class="analytics-stat-value" id="statSources">â€”</span>
                    <span class="analytics-stat-sub" id="statSourcesSub">Live vs Image</span>
                </div>
            </div>

            <!-- Charts Row 1: Trend + Distribution -->
            <div class="analytics-charts-row">
                <!-- Emotion Over Time (Line) -->
                <div class="analytics-chart-card large">
                    <div class="chart-header">
                        <h3>Emotion Frequency Over Time</h3>
                        <div class="chart-legend">
                            <span class="legend-dot blue"></span><span>Happy</span>
                            <span class="legend-dot grey"></span><span>Neutral</span>
                            <span class="legend-dot" style="background:#ef4444"></span><span>Sad</span>
                        </div>
                    </div>
                    <div class="chart-area tall">
                        <canvas id="trendChart"></canvas>
                    </div>
                    <div class="chart-x-labels" id="chartXLabels">
                        <span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span><span>SUN</span>
                    </div>
                </div>

                <!-- Emotion Distribution (Doughnut) -->
                <div class="analytics-chart-card small">
                    <div class="chart-header">
                        <h3>Emotion Distribution</h3>
                    </div>
                    <div class="donut-wrapper">
                        <canvas id="distChart"></canvas>
                        <div class="donut-center">
                            <span class="donut-label">Total</span>
                            <span class="donut-pct" id="donutTotal">100%</span>
                        </div>
                    </div>
                    <div class="distribution-legend" id="distLegend">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Charts Row 2: Bar (frequency) + Confidence per emotion -->
            <div class="analytics-charts-row">
                <!-- Bar Chart: Detection Frequency -->
                <div class="analytics-chart-card large">
                    <div class="chart-header">
                        <h3>Detection Frequency by Emotion</h3>
                    </div>
                    <div class="chart-area" style="height:200px">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- Confidence per Emotion -->
                <div class="analytics-chart-card small">
                    <div class="chart-header">
                        <h3>Avg. Confidence per Emotion</h3>
                    </div>
                    <div class="confidence-list" id="confList" style="margin-top:12px">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

        </div><!-- /page-body -->
    </main>

    <script type="module">
        import { requireAuth, logoutUser, populateUserUI, getEmotionLogs } from './js/firebase-config.js';

        // â”€â”€ Firebase Auth guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const user = await requireAuth();
        populateUserUI(user);
        window.handleLogout = function () { logoutUser(); };

        // â”€â”€ Color map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const COLORS = {
            Happy: '#22c55e', Neutral: '#8898b4', Sad: '#1978e5',
            Surprise: '#f97316', Anger: '#ef4444', Fear: '#7f13ec', Disgust: '#eab308'
        };
        const EMOJI = { Happy: 'ðŸ˜Š', Neutral: 'ðŸ˜', Sad: 'ðŸ˜¢', Surprise: 'ðŸ˜²', Anger: 'ðŸ˜ ', Fear: 'ðŸ˜¨', Disgust: 'ðŸ¤¢' };

        // â”€â”€ Load logs from Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let allLogs = [];
        try {
            allLogs = await getEmotionLogs(500);
        } catch (e) { console.warn('Failed to load Firestore logs:', e); }

        let charts = {};
        let currentFilter = '7';

        window.setTimeFilter = function (btn, val) {
            document.querySelectorAll('.time-filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = val;
            buildAnalytics();
        };

        function filterLogs(logs, days) {
            if (days === 'all') return logs;
            const cutoff = Date.now() - parseInt(days) * 24 * 3600 * 1000;
            return logs.filter(l => {
                const ts = l.isoDate ? new Date(l.isoDate).getTime()
                    : new Date(l.date.split('/').reverse().join('-') + 'T' + (l.time || '00:00:00')).getTime();
                return ts >= cutoff;
            });
        }

        function computeStats(logs) {
            const counts = {};
            const confSum = {};
            let live = 0, image = 0;
            logs.forEach(l => {
                counts[l.emotion] = (counts[l.emotion] || 0) + 1;
                confSum[l.emotion] = (confSum[l.emotion] || 0) + l.confidence;
                if (l.source === 'Live') live++; else image++;
            });
            return { counts, confSum, live, image };
        }

        function buildAnalytics() {
            const logs = filterLogs(allLogs, currentFilter);
            const { counts, confSum, live, image } = computeStats(logs);
            const total = logs.length;
            const dominant = Object.keys(counts).sort((a, b) => counts[b] - counts[a])[0] || 'â€”';
            const avgConf = total ? Math.round(logs.reduce((s, l) => s + l.confidence, 0) / total) : 0;

            document.getElementById('statTotal').textContent = total.toLocaleString();
            document.getElementById('statTotalSub').textContent = `${live} Live Â· ${image} Image`;
            document.getElementById('statDominant').textContent = dominant && dominant !== 'â€”' ? `${EMOJI[dominant] || ''} ${dominant}` : 'â€”';
            const domPct = (total > 0 && dominant && dominant !== 'â€”') ? Math.round((counts[dominant] / total) * 100) : 0;
            document.getElementById('statDominantSub').textContent = domPct ? `${domPct}% of detections` : 'No data yet';
            document.getElementById('statAvgConf').textContent = avgConf + '%';
            document.getElementById('statSources').textContent = `${live} / ${image}`;
            document.getElementById('statSourcesSub').textContent = 'Live / Image upload';

            buildTrendChart(logs);
            buildDistChart(counts, total);
            buildBarChart(counts);
            buildConfBars(counts, confSum);
        }

        function buildTrendChart(logs) {
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const labels = [];
            const happyData = [], neutralData = [], sadData = [];
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const d = new Date(today); d.setDate(today.getDate() - i);
                const label = days[d.getDay()];
                labels.push(label);
                const dayStr = d.toLocaleDateString('en-IN');
                const dayLogs = logs.filter(l => l.date === dayStr);
                happyData.push(dayLogs.filter(l => l.emotion === 'Happy').length);
                neutralData.push(dayLogs.filter(l => l.emotion === 'Neutral').length);
                sadData.push(dayLogs.filter(l => l.emotion === 'Sad').length);
            }

            const ctx = document.getElementById('trendChart').getContext('2d');
            const g = ctx.createLinearGradient(0, 0, 0, 260);
            g.addColorStop(0, 'rgba(34,197,94,0.22)');
            g.addColorStop(1, 'rgba(34,197,94,0)');

            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Happy', data: happyData, borderColor: '#22c55e', backgroundColor: g, fill: true, tension: 0.45, borderWidth: 3, pointRadius: 4, pointBackgroundColor: '#22c55e' },
                        { label: 'Neutral', data: neutralData, borderColor: 'rgba(136,152,180,0.7)', backgroundColor: 'transparent', fill: false, tension: 0.45, borderWidth: 2, borderDash: [5, 3], pointRadius: 3 },
                        { label: 'Sad', data: sadData, borderColor: '#1978e5', backgroundColor: 'transparent', fill: false, tension: 0.45, borderWidth: 2, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e293b', titleColor: '#94a3b8', bodyColor: '#f1f5f9', borderColor: '#334155', borderWidth: 1 } },
                    scales: { x: { display: false }, y: { display: true, grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#4e6080', font: { size: 11 } }, beginAtZero: true } }
                }
            });
        }

        function buildDistChart(counts, total) {
            const labels = Object.keys(counts);
            const data = labels.map(k => counts[k]);
            const colors = labels.map(k => COLORS[k] || '#8898b4');

            const ctx = document.getElementById('distChart').getContext('2d');
            if (charts.dist) charts.dist.destroy();
            charts.dist = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: '#111821', borderWidth: 3, hoverOffset: 8 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '72%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b', bodyColor: '#f1f5f9', borderColor: '#334155', borderWidth: 1,
                            callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed} (${Math.round((ctx.parsed / total) * 100)}%)` }
                        }
                    }
                }
            });

            const legend = document.getElementById('distLegend');
            legend.innerHTML = labels.map(k => `
        <div class="dist-item">
          <span class="dist-dot" style="background:${COLORS[k] || '#8898b4'}"></span>
          <span class="dist-name">${EMOJI[k] || ''} ${k}</span>
          <span class="dist-pct">${Math.round((counts[k] / total) * 100)}%</span>
        </div>`).join('');
        }

        function buildBarChart(counts) {
            const labels = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
            const data = labels.map(k => counts[k]);
            const colors = labels.map(k => COLORS[k] || '#8898b4');

            const ctx = document.getElementById('barChart').getContext('2d');
            if (charts.bar) charts.bar.destroy();
            charts.bar = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels.map(k => `${EMOJI[k] || ''} ${k}`), datasets: [{ data, backgroundColor: colors, borderRadius: 6, borderSkipped: false }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e293b', bodyColor: '#f1f5f9', borderColor: '#334155', borderWidth: 1 } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#8898b4', font: { size: 12 } } },
                        y: { display: true, grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#4e6080', font: { size: 11 } }, beginAtZero: true }
                    }
                }
            });
        }

        function buildConfBars(counts, confSum) {
            const cl = document.getElementById('confList');
            const keys = Object.keys(counts);
            if (!keys.length) { cl.innerHTML = '<p style="color:var(--text-muted);font-size:13px">No data</p>'; return; }
            cl.innerHTML = keys.sort((a, b) => (confSum[b] / counts[b]) - (confSum[a] / counts[a])).map(k => {
                const avg = Math.round(confSum[k] / counts[k]);
                const c = COLORS[k] || '#8898b4';
                return `
          <div class="conf-item" style="gap:6px">
            <div class="conf-header">
              <span>${EMOJI[k] || ''} ${k}</span>
              <span class="conf-pct" style="color:${c}">${avg}%</span>
            </div>
            <div class="conf-track">
              <div class="conf-fill" style="width:${avg}%;background:${c}" data-target="${avg}"></div>
            </div>
          </div>`;
            }).join('');

            requestAnimationFrame(() => {
                cl.querySelectorAll('.conf-fill').forEach(bar => {
                    const target = bar.dataset.target;
                    bar.style.width = '0%';
                    setTimeout(() => { bar.style.transition = 'width 1.1s cubic-bezier(0.4,0,0.2,1)'; bar.style.width = target + '%'; }, 80);
                });
            });
        }

        window.exportAnalytics = function () {
            alert('Analytics export: Your logs are available in the Logs page for CSV export.');
        };

        // Build on load
        buildAnalytics();
    </script>
</body>

</html>
